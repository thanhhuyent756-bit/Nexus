name: nexus testnet node (CLI)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"   # tự chạy mỗi 6 giờ
  push:
    paths:
      - ".github/workflows/nexus-node.yml"

concurrency:
  group: nexus-node
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run-node:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      DATA_DIR: nexus_data                     # nơi lưu state để cache/backup
      BACKUP_NAME: nexus_state_${{ github.run_id }}.tar.zst

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check (disk/RAM)
        run: |
          echo "Runner: $(uname -a)"
          df -h /
          free -h

      # Tạo RAM ảo 12GB
      - name: Provision 12G swap
        run: |
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo 10 | sudo tee /proc/sys/vm/swappiness
          swapon --show
          free -h

      # Khôi phục cache state (nếu có)
      - name: Restore chain data cache
        id: cache_restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: nexus-state-cli-v1-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            nexus-state-cli-v1-${{ runner.os }}-
            nexus-state-cli-v1-

      - name: Ensure data dir
        run: mkdir -p "${{ env.DATA_DIR }}"

      # Cài Nexus CLI
      - name: Install Nexus CLI
        run: |
          set -eux
          curl -sSfL https://cli.nexus.xyz/ | sh
          echo "${HOME}/.nexus/bin" >> $GITHUB_PATH

      # Debug: xác nhận CLI & thư mục
      - name: Debug environment
        run: |
          set -eux
          echo "$PATH"
          ls -la "${HOME}/.nexus" || true
          ls -la "${HOME}/.nexus/bin" || true
          "${HOME}/.nexus/bin/nexus-network" --version || true
          "${HOME}/.nexus/bin/nexus" --version || true

      # Xác định binary đúng (nexus-network hoặc nexus)
      - name: Detect Nexus CLI binary
        run: |
          set -eux
          BIN1="${HOME}/.nexus/bin/nexus-network"
          BIN2="${HOME}/.nexus/bin/nexus"
          if [ -x "$BIN1" ]; then
            echo "BIN=$BIN1" >> $GITHUB_ENV
          elif [ -x "$BIN2" ]; then
            echo "BIN=$BIN2" >> $GITHUB_ENV
          else
            echo "❌ Không tìm thấy Nexus CLI trong ~/.nexus/bin"
            exit 1
          fi

      # Đồng bộ cache -> ~/.nexus (nếu CLI dùng đường dẫn mặc định)
      - name: Prime CLI state from cache
        run: |
          mkdir -p "${HOME}/.nexus"
          rsync -a "${GITHUB_WORKSPACE}/${{ env.DATA_DIR }}/" "${HOME}/.nexus/" || true

      # Chạy headless ~5h55m (tắt TUI hoặc giả lập TTY nếu cần)
      - name: Start Nexus node (~5h55m) headless
        env:
          NODE_ID: ${{ secrets.NODE_ID }}
          TERM: xterm-256color
        run: |
          set -eux
          "${BIN}" --version || true

          if [ -z "${NODE_ID:-}" ]; then
            echo "❌ Chưa set secret NODE_ID trong repo (Settings → Secrets → Actions)."
            exit 1
          fi

          # In help để dò flags
          "${BIN}" start --help || true

          # Ưu tiên cờ headless nếu có
          if "${BIN}" start --help | grep -q -- '--no-tui'; then
            CMD="${BIN} start --node-id ${NODE_ID} --no-tui"
          elif "${BIN}" start --help | grep -qi -- '--daemon'; then
            CMD="${BIN} start --node-id ${NODE_ID} --daemon"
          else
            # Không có flag headless → giả lập TTY bằng 'script'
            sudo apt-get update -y
            sudo apt-get install -y util-linux
            CMD="script -q -e -c '${BIN} start --node-id ${NODE_ID}' /dev/null"
          fi

          echo "Running: $CMD"
          # Giữ tiến trình ~5h55m
          timeout 21300 bash -lc "$CMD" 2>&1 | tee -a nexus.log || true

      # Sau khi dừng, copy state về DATA_DIR để cache/backup
      - name: Sync back state
        if: always()
        run: |
          rsync -a --delete "${HOME}/.nexus/" "${GITHUB_WORKSPACE}/${{ env.DATA_DIR }}/" || true

      - name: Upload node log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nexus.log
          path: nexus.log
          retention-days: 7

      - name: Compress data
        if: always()
        run: |
          sudo apt-get update -y && sudo apt-get install -y zstd
          tar -I "zstd -19" -cf "/tmp/${{ env.BACKUP_NAME }}" -C "${GITHUB_WORKSPACE}" "${{ env.DATA_DIR }}"

      - name: Upload backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BACKUP_NAME }}
          path: /tmp/${{ env.BACKUP_NAME }}
          retention-days: 7

      - name: Save cache (best-effort, unique key)
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: nexus-state-cli-v1-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}-${{ github.run_attempt }}
