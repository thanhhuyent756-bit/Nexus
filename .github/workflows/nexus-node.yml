name: nexus testnet node (CLI)

on:
  workflow_dispatch: {}
  push:
    paths:
      - ".github/workflows/nexus-node.yml"
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: nexus-node
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run-node:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      DATA_DIR: nexus_data
      BACKUP_NAME: nexus_state_${{ github.run_id }}.tar.zst

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check
        run: |
          echo "Runner ready: $(uname -a)"
          echo "Disk:"
          df -h /
          echo "RAM:"
          free -h

      - name: Provision 12G swap and tune
        run: |
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo 10 | sudo tee /proc/sys/vm/swappiness
          swapon --show
          free -h

      - name: Restore chain data cache
        id: cache_restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: nexus-state-cli-v1-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            nexus-state-cli-v1-${{ runner.os }}-
            nexus-state-cli-v1-

      - name: Ensure data dir
        run: mkdir -p "${{ env.DATA_DIR }}"

      - name: Install Nexus CLI
        run: |
          set -eux
          curl -sSfL https://cli.nexus.xyz/ | sh
          echo "${HOME}/.nexus/bin" >> $GITHUB_PATH

      - name: Debug environment
        run: |
          set -eux
          echo "$PATH"
          ls -la "${HOME}/.nexus" || true
          ls -la "${HOME}/.nexus/bin" || true
          which nexus-network || true
          which nexus || true

      - name: Detect Nexus CLI binary
        run: |
          set -eux
          BIN1="${HOME}/.nexus/bin/nexus-network"
          BIN2="${HOME}/.nexus/bin/nexus"
          if [ -x "$BIN1" ]; then
            echo "BIN=$BIN1" >> $GITHUB_ENV
          elif [ -x "$BIN2" ]; then
            echo "BIN=$BIN2" >> $GITHUB_ENV
          else
            echo "❌ Không tìm thấy Nexus CLI trong ~/.nexus/bin"
            exit 1
          fi

      - name: Prime local CLI state from cache
        run: |
          mkdir -p "${HOME}/.nexus"
          rsync -a "${GITHUB_WORKSPACE}/${{ env.DATA_DIR }}/" "${HOME}/.nexus/" || true

      - name: Start Nexus node (~5h55m)
        env:
          NODE_ID: ${{ secrets.NODE_ID }} # phải tạo secret này = 37003063
        run: |
          set -eux
          "${BIN}" --version || true
          if [ -z "${NODE_ID:-}" ]; then
            echo "❌ Chưa set secret NODE_ID trong repo (Settings → Secrets → Actions)."
            exit 1
          fi
          timeout 5h55m "${BIN}" start --network testnet --node-id "${NODE_ID}" 2>&1 | tee -a nexus.log || true

      - name: Sync back state
        if: always()
        run: |
          rsync -a --delete "${HOME}/.nexus/" "${GITHUB_WORKSPACE}/${{ env.DATA_DIR }}/" || true

      - name: Upload node log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nexus.log
          path: nexus.log
          retention-days: 7

      - name: Compress data
        if: always()
        run: |
          sudo apt-get update -y && sudo apt-get install -y zstd
          tar -I "zstd -19" -cf "/tmp/${{ env.BACKUP_NAME }}" -C "${GITHUB_WORKSPACE}" "${{ env.DATA_DIR }}"

      - name: Upload backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BACKUP_NAME }}
          path: /tmp/${{ env.BACKUP_NAME }}
          retention-days: 7

      - name: Save cache (best-effort)
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: ${{ env.DATA_DIR }}
          key: nexus-state-cli-v1-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}-${{ github.run_attempt }}
